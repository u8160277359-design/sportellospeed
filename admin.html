<script>
    // Configurazione Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAA9sbM03-XbikVrBGhVV6H_du6E28WIg4",
        authDomain: "sportellospeed.firebaseapp.com",
        projectId: "sportellospeed",
        storageBucket: "sportellospeed.firebasetorage.app",
        messagingSenderId: "224365418093",
        appId: "1:224365418093:web:b01c57d26ba86300e85164",
        measurementId: "G-SHBNCHFG1F"
    };

    // Inizializza Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase inizializzato correttamente");
    } catch (e) {
        console.error("Errore inizializzazione Firebase:", e);
    }

    // Funzioni per interagire con Firestore
    async function saveChatToFirestore(chat) {
        try {
            const db = firebase.firestore();
            await db.collection("chats").doc(chat.id).set(chat);
            console.log("Chat salvata su Firestore");
        } catch (error) {
            console.error("Errore salvataggio su Firestore:", error);
            saveToLocalStorage(chat);
        }
    }

    async function loadChatsFromFirestore() {
        try {
            const db = firebase.firestore();
            const snapshot = await db.collection("chats").orderBy("timestamp", "desc").get();
            const chats = [];
            snapshot.forEach(doc => {
                chats.push(doc.data());
            });
            return chats;
        } catch (error) {
            console.error("Errore caricamento da Firestore:", error);
            return JSON.parse(localStorage.getItem('whatsapp_chats')) || [];
        }
    }

    async function deleteChatFromFirestore(chatId) {
        try {
            const db = firebase.firestore();
            await db.collection("chats").doc(chatId).delete();
            console.log("Chat eliminata da Firestore");
            return true;
        } catch (error) {
            console.error("Errore eliminazione da Firestore:", error);
            return false;
        }
    }

    // Funzioni di fallback per localStorage
    function saveToLocalStorage(chat) {
        let chats = JSON.parse(localStorage.getItem('whatsapp_chats')) || [];
        const existingIndex = chats.findIndex(c => c.id === chat.id);
        
        if (existingIndex >= 0) {
            chats[existingIndex] = chat;
        } else {
            chats.unshift(chat);
        }
        
        localStorage.setItem('whatsapp_chats', JSON.stringify(chats));
    }

    function deleteFromLocalStorage(chatId) {
        let chats = JSON.parse(localStorage.getItem('whatsapp_chats')) || [];
        chats = chats.filter(chat => chat.id !== chatId);
        localStorage.setItem('whatsapp_chats', JSON.stringify(chats));
    }

    // Util per normalizzare numero
    function normalizePhone(phone) {
        let p = (phone || '').replace(/\D/g, '');
        p = p.replace(/^0+/, '');
        if (!p.startsWith('39')) p = '39' + p;
        return p;
    }

    // Stato
    let chats = [];

    // Rendering lista chat
    async function updateChatList() {
        chats = await loadChatsFromFirestore();
        const chatList = document.getElementById('whatsapp-chat-list');
        chatList.innerHTML = '';

        if (chats.length === 0) {
            chatList.innerHTML = '<p style="text-align:center;padding:20px;color:#888;">Nessuna chat ricevuta</p>';
            return;
        }

        chats.sort((a,b) => {
            if (a.status !== b.status) return a.status === 'unread' ? -1 : 1;
            return new Date(b.timestamp) - new Date(a.timestamp);
        });

        chats.forEach((chat) => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.dataset.id = chat.id;

            const initial = (chat.userName || '?').charAt(0).toUpperCase();
            const time = new Date(chat.timestamp);
            const timeString = time.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});

            const attachmentsIndicator = chat.attachments && chat.attachments.length > 0 
                ? ` <i class="fas fa-paperclip" style="color: var(--poste-blue);"></i>` 
                : '';

            chatItem.innerHTML = `
                <div style="display: flex; align-items: center; margin-right: 10px;">
                    <input type="checkbox" class="chat-checkbox" data-id="${chat.id}">
                </div>
                <div class="chat-avatar">${initial}</div>
                <div class="chat-content">
                    <div class="chat-user">${chat.userName}${attachmentsIndicator}</div>
                    <div class="chat-preview">${chat.question}</div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">${timeString}</div>
                    <div class="chat-status ${chat.status === 'unread' ? 'status-unread':'status-read'}">
                        <i class="fas ${chat.status === 'unread' ? 'fa-check-circle':'fa-check-double'}"></i>
                    </div>
                    <button class="delete-btn" data-id="${chat.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            chatItem.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-checkbox') && !e.target.closest('.delete-btn')) {
                    openChat(chat.id);
                }
            });
            
            chatItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });

            const checkbox = chatItem.querySelector('.chat-checkbox');
            checkbox.addEventListener('change', function() {
                toggleChatSelection(this);
                updateSelectAllCheckbox();
            });

            chatList.appendChild(chatItem);
        });
        
        setTimeout(setupSelectAll, 0);
    }

    // Funzione per eliminare una chat singola
    async function deleteChat(chatId) {
        if (confirm('Sei sicuro di voler eliminare questa chat?')) {
            const success = await deleteChatFromFirestore(chatId);
            if (!success) {
                deleteFromLocalStorage(chatId);
            }
            updateChatList();
        }
    }

    // Funzione per eliminare le chat selezionate
    async function deleteSelectedChats() {
        const selectedCheckboxes = document.querySelectorAll('.chat-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Seleziona almeno una chat da eliminare.');
            return;
        }
        
        if (confirm(`Sei sicuro di voler eliminare ${selectedCheckboxes.length} chat?`)) {
            const idsToDelete = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.id);
            
            for (const id of idsToDelete) {
                const success = await deleteChatFromFirestore(id);
                if (!success) {
                    deleteFromLocalStorage(id);
                }
            }
            
            updateChatList();
        }
    }

    // Gestione selezione/deselezione tutti
    function setupSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all');
        const chatCheckboxes = document.querySelectorAll('.chat-checkbox');
        
        selectAllCheckbox.addEventListener('change', function() {
            chatCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                toggleChatSelection(checkbox);
            });
        });
        
        chatCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleChatSelection(this);
                updateSelectAllCheckbox();
            });
        });
        
        updateSelectAllCheckbox();
    }

    function toggleChatSelection(checkbox) {
        const chatItem = checkbox.closest('.chat-item');
        if (checkbox.checked) {
            chatItem.classList.add('selected');
        } else {
            chatItem.classList.remove('selected');
        }
    }

    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('select-all');
        const chatCheckboxes = document.querySelectorAll('.chat-checkbox');
        const allChecked = chatCheckboxes.length > 0 && 
                          Array.from(chatCheckboxes).every(checkbox => checkbox.checked);
        
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = !allChecked && 
                                        Array.from(chatCheckboxes).some(checkbox => checkbox.checked);
    }

    // Apri dettaglio chat
    async function openChat(chatId) {
        const chat = chats.find(c => c.id === chatId);
        if (!chat) return;

        chat.status = 'read';
        await saveChatToFirestore(chat);
        updateChatList();

        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-overlay').style.display = 'block';

        const questionList = document.getElementById('question-list');
        questionList.innerHTML = '';

        const time = new Date(chat.timestamp);
        const timeString = time.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});

        let attachmentsHTML = '';
        if (chat.attachments && chat.attachments.length > 0) {
            attachmentsHTML = `
                <div class="attachments-section">
                    <h4>Allegati:</h4>
                    ${chat.attachments.map((attachment, index) => `
                        <div class="attachment-item">
                            <span>${attachment.name}</span>
                            <button type="button" class="download-btn" data-index="${index}">
                                <i class="fas fa-download"></i> Scarica
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        const item = document.createElement('div');
        item.className = 'question-item';
        item.innerHTML = `
            <div class="question-header">
                <span class="user-info">${chat.userName} (${chat.userPhone})</span>
                <span class="question-time">Oggi, ${timeString}</span>
            </div>
            <div class="question-content"><p>${chat.question}</p></div>
            ${attachmentsHTML}
            <div class="admin-response">
                <input type="text" placeholder="Scrivi la risposta qui..." id="response-${chat.id}">
                <button type="button" class="send-reply-btn"><i class="fab fa-whatsapp"></i> Invia via WhatsApp</button>
            </div>
        `;
        questionList.appendChild(item);

        item.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = e.target.closest('.download-btn').dataset.index;
                const attachment = chat.attachments[index];
                downloadAttachment(attachment.data, attachment.name);
            });
        });

        item.querySelector('.send-reply-btn').addEventListener('click', () => sendResponse(chat.id));
    }

    // Funzione per scaricare allegati
    function downloadAttachment(base64Data, fileName) {
        const parts = base64Data.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = window.atob(parts[1]);
        const uInt8Array = new Uint8Array(raw.length);
        
        for (let i = 0; i < raw.length; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }
        
        const blob = new Blob([uInt8Array], { type: contentType });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }

    // Invia risposta via WhatsApp
    async function sendResponse(chatId) {
        const chat = chats.find(c => c.id === chatId);
        if (!chat) return;

        const input = document.getElementById(`response-${chat.id}`);
        const msg = (input && input.value || '').trim();

        if (!msg) { 
            alert('Per favore, inserisci una risposta prima di inviare.'); 
            return; 
        }

        sendWhatsAppMessage(chat.userPhone, msg);
        input.value = '';

        chat.status = 'read';
        await saveChatToFirestore(chat);
        updateChatList();

        setTimeout(() => {
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-overlay').style.display = 'none';
        }, 300);
    }

    function sendWhatsAppMessage(phone, message) {
        const formattedPhone = normalizePhone(phone);
        const encoded = encodeURIComponent(message || '');
        const url = `https://wa.me/${formattedPhone}?text=${encoded}`;
        const win = window.open(url, '_blank', 'noopener');
        if (!win) window.location.href = url;
    }

    // Event listener per eliminazione multipla
    document.getElementById('delete-selected').addEventListener('click', deleteSelectedChats);

    // Eventi UI pannello
    document.getElementById('close-admin').addEventListener('click', () => {
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('admin-overlay').style.display = 'none';
    });
    document.getElementById('admin-overlay').addEventListener('click', () => {
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('admin-overlay').style.display = 'none';
    });

    // Sincronizzazione in tempo reale con Firestore
    function setupRealtimeListener() {
        try {
            const db = firebase.firestore();
            db.collection("chats")
                .orderBy("timestamp", "desc")
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added" || change.type === "modified" || change.type === "removed") {
                            updateChatList();
                        }
                    });
                });
            console.log("Listener Firestore attivato");
        } catch (error) {
            console.error("Errore listener Firestore:", error);
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', function() {
        updateChatList();
        setupRealtimeListener();
    });
</script>